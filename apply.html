<script>
    function toggleSubOptions(subId, titleDiv) {
        const subDiv = document.getElementById(subId);
        subDiv.classList.toggle('open');
        const arrow = titleDiv.querySelector('.arrow');
        arrow.classList.toggle('rotate');
    }

    function showSelections() {
        const checkboxes = document.querySelectorAll('input[name="option"]:checked');
        const selected = Array.from(checkboxes).map(cb => cb.value);
        const resultDiv = document.getElementById('result');
        if (selected.length > 0) {
            resultDiv.innerHTML = "<h2>醫整中心所需參數：</h2><ul>" +
                selected.map(item => `<li>${item}</li>`).join('') +
                "</ul>";
        } else {
            resultDiv.innerHTML = "<p>您尚未勾選任何項目。</p>";
        }
    }

    function submitToREDCap() {
        const checkboxes = document.querySelectorAll('input[name="option"]:checked');
        const selected = Array.from(checkboxes).map(cb => cb.value);
        if (selected.length === 0) {
            alert("請先勾選至少一個項目！");
            return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const record_id = urlParams.get('record_id');

        if (!record_id) {
            alert("無法取得 record_id，請確認網址中包含 ?record_id=xxx");
            return;
        }

        sendToREDCap(selected, record_id);
    }

    function sendToREDCap(selectedValues, record_id) {
        const token = 'YOUR_API_TOKEN_HERE'; // 請換成你的 REDCap token
        const data = new FormData();
        data.append('token', token);
        data.append('content', 'record');
        data.append('format', 'json');
        data.append('type', 'flat');
        data.append('data', JSON.stringify([
            {
                record_id: record_id,
                name_2: selectedValues.join(', ')
            }
        ]));

        fetch('https://redcap.ntuh.gov.tw/api/', {
            method: 'POST',
            body: data
        })
        .then(response => response.json())
        .then(result => {
            alert('✅ 成功送出至 REDCap！視窗即將關閉');
            window.close();
        })
        .catch(error => {
            alert('❌ 傳送失敗：' + error);
        });
    }
</script>
</body>
</html>
</body>
</html>
